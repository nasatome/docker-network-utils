services:
  traefik:
    image: traefik:v3.6.5
    restart: always
    command:
      # Load static configuration (includes Cloudflare trusted IPs)
      - "--configFile=/etc/traefik/traefik.yml"

      - "--log.level=${TRAEFIK_LOG_LEVEL}"
      - "--ping=${TRAEFIK_PING}"

      # v3 migration: keep v2 rules syntax for backwards compatibility
      - "--core.defaultRuleSyntax=v2"

      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.watch=true"
      - "--providers.docker.network=${TRAEFIK_DEFAULT_DOCKER_NETWORK}"

      # Entrypoints (TLS config - entrypoint addresses are in traefik.yml)
      - "--entrypoints.websecure.http.tls.certResolver=${TRAEFIK_CERT_RESOLVER}"

      # ACME DNS challenge (Cloudflare) - Traefik v3 syntax
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.dnschallenge=true"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.dnschallenge.provider=${TRAEFIK_DNS_PROVIDER}"
      # v3 propagation settings (replaces deprecated delaybeforecheck)
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.dnschallenge.propagation.delaybeforechecks=${TRAEFIK_DNS_DELAY_BEFORE_CHECK}"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.dnschallenge.propagation.disableanschecks=true"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.storage=/etc/traefik/acme/acme.json"

      # API/Dashboard (secured via labels below)
      - "--api=${TRAEFIK_API}"
      - "--api.dashboard=${TRAEFIK_API_DASHBOARD}"

    networks:
      - traefik
    ports:
      - "${TRAEFIK_HOST_HTTP_PORT}:80"
      - "${TRAEFIK_HOST_HTTPS_PORT}:443"
    volumes:
      - ${DOCKER_SOCK_PATH}:/var/run/docker.sock:ro
      - ./acme:/etc/traefik/acme
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
    env_file:
      - ./.${TRAEFIK_DNS_PROVIDER}-api.key
    labels:
      - "traefik.enable=true"
      # Dashboard secure mode: route to api@internal with basicAuth
      - "traefik.http.routers.traefik-dashboard.rule=Host(`${TRAEFIK_FRONTEND_RULE}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS}"

  # ==========================================================================
  # Ofelia - Docker Job Scheduler
  # Updates Cloudflare IP ranges in traefik.yml weekly
  # @see https://github.com/mcuadros/ofelia
  # ==========================================================================
  ofelia:
    image: mcuadros/ofelia:latest
    restart: always
    depends_on:
      - traefik
    environment:
      - TZ=America/Mexico_City
    volumes:
      - ${DOCKER_SOCK_PATH}:/var/run/docker.sock:ro
      - ./ofelia.ini:/etc/ofelia/config.ini:ro
    command: daemon --config=/etc/ofelia/config.ini

networks:
  traefik:
    driver: bridge
