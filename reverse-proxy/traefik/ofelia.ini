# Ofelia Cron Jobs Configuration
# Schedule format: seconds minutes hours day-of-month month day-of-week
#
# Discord notifications: Create .discord-webhook file with your webhook URL
# echo "https://discord.com/api/webhooks/ID/TOKEN" > .discord-webhook

# Update Cloudflare trusted IPs weekly (Sunday 6PM CDMX)
# Downloads official IP ranges, restarts Traefik, notifies Discord on failure
[job-run "cloudflare-ips"]
schedule = 0 0 18 * * 0
image = alpine:latest
network = reverse_traefik
volume = /var/run/docker.sock:/var/run/docker.sock
volume = /opt/prj/docker-network-utils/reverse-proxy/traefik/.discord-webhook:/etc/discord-webhook:ro
volume = /opt/prj/docker-network-utils/reverse-proxy/traefik/scripts:/scripts:ro
command = sh -c 'apk add -q curl docker-cli && curl -sf https://www.cloudflare.com/ips-v4 -o /tmp/v4.txt && curl -sf https://www.cloudflare.com/ips-v6 -o /tmp/v6.txt && echo "[INFO] Got $(wc -l < /tmp/v4.txt) IPv4, $(wc -l < /tmp/v6.txt) IPv6" && TRAEFIK=$(docker ps -q -f label=com.docker.compose.service=traefik) && docker restart $TRAEFIK && sleep 30 && docker ps -q -f id=$TRAEFIK -f status=running | grep -q . && echo "[OK] Traefik running" || /scripts/notify-discord.sh Traefik Down - failed to restart after Cloudflare IP update'
